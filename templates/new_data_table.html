<!DOCTYPE html>
<html lang="en">
	<head>
        <style>
.chip {
  display: inline-block;
  padding: 0 5px;
  height: 20px;
  font-size: 16px;
  line-height: 20px;
  border-radius: 25px;
  background-color: #f1f1f1;
}

.closebtn {
  padding-left: 5px;
  color: #888;
  font-weight: bold;
/*   float: right; */
  font-size: 20px;
  cursor: pointer;
}

.closebtn:hover {
  color: #000;
}
        </style>
		<title> New Data </title>			
        <script>

function colorTagText(row){
    // row = 0;
    row_col0 = "row_"+row+"_col_0"
    row_col1 = "row_"+row+"_col_1"
    sms_text = document.getElementById(row_col0).textContent;
    tags = document.getElementById(row_col1).getElementsByTagName("div")//[0].innerHTML;
    // debugger;
    for (let i = 0; i < tags.length; i++) {
        sms_text = sms_text.replaceAll(tags[i].innerHTML, "<font style='background-color:green'>"+tags[i].innerHTML+"</font>");
    }
    // alert(sms_text);
    document.getElementById(row_col0).innerHTML = sms_text;
//     for (String tag : tag_texts) {
//         sms_text = sms_text.replace(tag, "<font color='blue'>"+tag+"</font>");
//         alert(sms_text);
//     }
    
}
            
function colorAllRows(){
    let ln = document.getElementsByTagName('td').length/2;
    console.log('no. of rows in table:'+ln);
    for (let i = 0; i < ln; i++) {
        colorTagText(i);
    }
}
            
function getSelectionText() {
    var text = "";
    if (window.getSelection) {
        getsel = window.getSelection();
        text = getsel.toString();
        // console.log(getsel);
    } else if (document.selection && document.selection.type != "Control") {
        getsel = document.selection;
        text = getsel.selection.createRange().text;
        // console.log(getsel);
    }
    return [text, getsel.anchorNode.parentElement.id];
}

function addTagToRow(){
    let values = getSelectionText();
    text = values[0];
    id = values[1];
    row = id[4];
    row_col0 = "row_"+row+"_col_0";
    row_col1 = "row_"+row+"_col_1";
    i = document.getElementById(row_col1).getElementsByTagName('div').length;
    document.getElementById(row_col1).innerHTML += `<div class='chip' id='row_${row}_col_1_i_${i}'>`+text+"</div>";
    // alert('asdasd');
    // debugger;
    spanEle = document.createElement("span");
    spanEle.setAttribute('class','closebtn');
    spanEle.setAttribute('onclick',"closeTag(this)");
    spanEle.innerHTML = "&times;";
    document.getElementById(row_col1).innerHTML += spanEle.outerHTML
    // debugger;
}

function closeTag(el){
    // alert('closing!');
    // debugger;
    document.getElementById(el.previousSibling.id).remove();
    el.remove();
}

function postCurrentStateToBackend(){
    // get the tags as a list
    tags_eles = document.getElementsByClassName('chip');
    ln = tags_eles.length;
    var tags_dict = {};
    for (let i = 0; i < ln; i++) {
        tags_dict[tags_eles[i].id] = tags_eles[i].textContent;
    };
    
    fetch('http://localhost:5000/save_data', {
    method: 'POST',
    headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(tags_dict)
})
.then(response => response.json())
.then(response => console.log(response))
    
    // debugger;
    // post them to backend
}
            
function downloadAsCSV(){
    postCurrentStateToBackend();    
}
            
        </script>
	</head>
	<body>
        <div id="upload_area">
<!--             <button id="upload_button" onclick="uploadCSV()">Upload CSV</button> -->
          <form action = "http://localhost:5000/upload_csv" method = "POST" enctype = "multipart/form-data">
             <input type = "file" name = "file" />
             <input type = "submit"/>
          </form>
        </div>
        
		<div align="center" id="tables_row">
			<table>
				<h1>
				<!--Displaying the converted table-->
					{% for table in tables %}
<!-- 					<h2>{{titles[loop.index]}}</h2>							 -->
					{{ table|safe }}
					{% endfor %}	
				</h1>
			</table>
            <button id='add_tag_button' onclick="addTagToRow()">Add Tag</button>
            <button id='refresh_button' onclick="colorAllRows()">Refresh Coloring</button>
            <button id='save_button' onclick="postCurrentStateToBackend()">Save Progress</button>
<!--             <button id='upload_csv' href="data/truth_uploaded" download="truth_uploaded.csv">Download as CSV</button> -->
            <a href="data/truth_uploaded" download="truth_uploaded.csv">Download</a>
		</div>
	</body>
    <script>
        // document.getElementById("tables_row").style.color = "blue";
// document.onmouseup = document.onkeyup = document.onselectionchange = function() {
// document.onmousedown = function() {
//   document.getElementById("row_0_col_1").innerHTML = "['"+getSelectionText()+"']";
// };
        </script>
</html>

        
        